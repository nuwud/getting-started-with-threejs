<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive 3D Ball with Three.js</title>
  
  <!-- 
    IMPORTANT: DO NOT REMOVE OR MODIFY THE BALL ELEMENT IN THIS APPLICATION.
    The 3D ball is an essential component. Any modification that causes
    the ball to disappear will break core functionality.
    
    AI Assistant Note: Ensure any code changes preserve the ball display.
  -->
  
  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <!-- Hamburger Menu -->
  <div class="hamburger-menu" id="menu-btn">
    <span></span>
  </div>
  
  <!-- Instructions Panel -->
  <div id="instructions">
    <h2>Interactive 3D Ball</h2>
    
    <h3>Basic Interactions</h3>
    <ul>
      <li><strong>Hover:</strong> Move your mouse over the ball to create dents and hear warm pad sounds</li>
      <li><strong>Click & Drag:</strong> Rotate the ball in any direction</li>
      <li><strong>Cross Facet Boundaries:</strong> Hear unique crunchy sonic textures for each facet</li>
    </ul>
    
    <h3>Special Effects</h3>
    <ul>
      <li><strong>Double-Click:</strong> Toggle rainbow mode with color cycling</li>
      <li><strong>Mouse Wheel:</strong> Create spiky deformations</li>
      <li><strong>Right-Click:</strong> Particle explosion effect</li>
    </ul>
    
    <h3>Sound Experience</h3>
    <p>Each triangle facet produces a unique sound with its own timbre. The hover movement creates warm musical tones that change with cursor position.</p>
    
    <!-- Effect Controls -->
    <h3>Effect Controls</h3>
    <div class="button-container">
      <button class="effect-button" id="btn-rainbow">Rainbow Mode</button>
      <button class="effect-button" id="btn-magnetic">Magnetic Effect</button>
      <button class="effect-button" id="btn-blackhole">Blackhole</button>
      <button class="effect-button" id="btn-explosion">Explosion</button>
      <button class="effect-button" id="btn-reset">Reset Ball</button>
    </div>
    
    <!-- Audio Controls -->
    <h3>Audio Controls</h3>
    <div class="button-container">
      <button class="effect-button audio-button" id="btn-audio-standard">Standard Audio</button>
      <button class="effect-button audio-button" id="btn-audio-continuous">Continuous Audio Mode</button>
      <button class="effect-button audio-button" id="btn-audio-test">Test Audio</button>
    </div>
  </div>
  
  <!-- Status Indicator -->
  <div id="status-indicator"></div>

  <!-- New Controls -->
  <div class="controls">
    <button id="toggleSpikyMode" onclick="window.appControls && window.appControls.toggleSpikyMode && window.appControls.toggleSpikyMode()">Toggle Spiky Mode</button>
    <button id="toggleFacetHighlight" onclick="window.appControls && window.appControls.toggleFacetHighlighting && window.appControls.toggleFacetHighlighting()">Toggle Facet Highlighting</button>
    <button id="toggleTrail" onclick="window.appControls && window.appControls.toggleTrailEffect && window.appControls.toggleTrailEffect()">Toggle Motion Trail</button>
  </div>
  
  <!-- Add this to your HTML, likely near other UI controls -->
  <div class="audio-controls">
    <div class="control-group">
      <label for="audio-enabled">Audio Enabled</label>
      <input type="checkbox" id="audio-enabled" checked>
    </div>
    
    <div class="control-group">
      <label for="continuous-mode">Continuous Mode</label>
      <input type="checkbox" id="continuous-mode" checked>
    </div>
    
    <div class="control-group">
      <label for="visualization">Visualization</label>
      <input type="checkbox" id="visualization" checked>
    </div>
    
    <div class="control-group">
      <label for="volume">Volume</label>
      <input type="range" id="volume" min="0" max="100" value="70">
    </div>
  </div>
  
  <div class="audio-debug-panel">
    <button id="btn-standard-audio">Standard Audio</button>
    <button id="btn-continuous-audio">Continuous Audio</button>
    <button id="btn-audio-visualization">Toggle Visualization</button>
    <div class="volume-control">
      <label for="volume-slider">Volume:</label>
      <input id="volume-slider" type="range" min="0" max="100" value="70">
    </div>
    <button id="btn-audio-debug" onclick="debugAudio()">Debug Audio</button>
  </div>

  <div id="controls">
    <div class="control-group">
        <h3>Visual Effects</h3>
        <button id="btn-facet-highlight" class="effect-button">Toggle Facet Highlighting</button>
        <button id="btn-spiky" class="effect-button">Toggle Spiky Mode</button>
        <button id="btn-trail" class="effect-button">Toggle Trail Effect</button>
    </div>
  </div>

  <div id="interface">
    <button id="resetBall">Reset Ball</button>
    <button id="toggleWireframe">Toggle Wireframe</button>
    <button id="emergencyBall">Emergency Ball</button>
    <div class="toggle" id="toggleGreenSquares"></div>
    <button id="standardAudio">Standard Audio</button>
    <button id="continuousAudio">Continuous Audio</button>
    <button id="toggleVisualization">Toggle Visualization</button>
    <button id="debugAudio">Debug Audio</button>
    <button id="testAudio">Test Audio</button>
  </div>
  <div id="debug-panel">
    <button id="resetBallDebug">Reset Ball</button>
    <button id="toggleWireframeDebug">Toggle Wireframe</button>
    <button id="emergencyBallDebug">Emergency Ball</button>
  </div>
  <div id="ball"></div>

  <!-- Main entry point script -->
  <script type="module" src="js/main.js"></script>
  
  <!-- Debug script to help diagnose issues - but DON'T auto-initialize it -->
  <script type="module">
    import { initDebug } from './debug.js';
    
    // Make debug initialization available on window
    window.initDebug = initDebug;
    
    // Add a button to manually initialize debug
    const debugButton = document.createElement('button');
    debugButton.textContent = 'Debug Tools';
    debugButton.style.position = 'fixed';
    debugButton.style.top = '10px';
    debugButton.style.left = '10px';
    debugButton.style.zIndex = '1000';
    debugButton.style.background = '#4466aa';
    debugButton.style.color = 'white';
    debugButton.style.border = 'none';
    debugButton.style.borderRadius = '4px';
    debugButton.style.padding = '8px 16px';
    debugButton.style.cursor = 'pointer';
    
    debugButton.onclick = function() {
      initDebug();
    };
    
    // Add button to DOM after a delay
    setTimeout(() => {
      document.body.appendChild(debugButton);
    }, 2000);
  </script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const menuBtn = document.getElementById('menu-btn');
      const instructions = document.getElementById('instructions');
      
      menuBtn.addEventListener('click', () => {
        menuBtn.classList.toggle('open');
        instructions.classList.toggle('open');
      });
      
      // Close instructions when clicking outside (but not on the ball)
      document.addEventListener('click', (e) => {
        if (!instructions.contains(e.target) && 
            e.target !== menuBtn && 
            !menuBtn.contains(e.target) &&
            !e.target.closest('canvas')) {
          instructions.classList.remove('open');
          menuBtn.classList.remove('open');
        }
      });
      
      // Add event listeners for effect buttons
      const buttons = {
        rainbow: document.getElementById('btn-rainbow'),
        magnetic: document.getElementById('btn-magnetic'),
        blackhole: document.getElementById('btn-blackhole'),
        explosion: document.getElementById('btn-explosion'),
        reset: document.getElementById('btn-reset'),
        audioStandard: document.getElementById('btn-audio-standard'),
        audioContinuous: document.getElementById('btn-audio-continuous'),
        audioTest: document.getElementById('btn-audio-test')
      };
      
      // We'll define these functions in main.js and make them globally available
      if (buttons.rainbow) {
        buttons.rainbow.addEventListener('click', () => {
          if (window.appControls && window.appControls.toggleRainbowMode) {
            window.appControls.toggleRainbowMode();
            showStatus('Rainbow Mode ' + (window.app.isRainbowMode ? 'Activated' : 'Deactivated'));
          }
        });
      }
      
      if (buttons.magnetic) {
        buttons.magnetic.addEventListener('click', () => {
          if (window.appControls && window.appControls.toggleMagneticMode) {
            window.appControls.toggleMagneticMode();
            showStatus('Magnetic Effect ' + (window.app.isMagneticMode ? 'Activated' : 'Deactivated'));
          }
        });
      }
      
      if (buttons.blackhole) {
        buttons.blackhole.addEventListener('click', () => {
          if (window.appControls && window.appControls.createBlackholeEffect) {
            window.appControls.createBlackholeEffect();
            showStatus('Blackhole Effect Activated');
          }
        });
      }
      
      if (buttons.explosion) {
        buttons.explosion.addEventListener('click', () => {
          if (window.appControls && window.appControls.createExplosion) {
            window.appControls.createExplosion();
            showStatus('Explosion Effect Activated');
          }
        });
      }
      
      if (buttons.reset) {
        buttons.reset.addEventListener('click', () => {
          if (window.appControls && window.appControls.resetBall) {
            window.appControls.resetBall();
            showStatus('Ball Reset to Default State');
          }
        });
      }
      
      // Add event listeners for audio control buttons
      if (buttons.audioStandard) {
        buttons.audioStandard.addEventListener('click', () => {
          // Toggle audio mode to standard
          if (window.audioSystem && window.audioSystem.soundScheduler) {
            // Reset to standard settings
            if (window.audioSystem.soundScheduler.setContinuousMode) {
              window.audioSystem.soundScheduler.setContinuousMode(false);
            }
            window.audioSystem.soundScheduler.maxSoundsPerSecond = 20;
            showStatus('Standard Audio Mode Activated');
          } else {
            showStatus('Audio system not fully initialized');
          }
        });
      }
      
      if (buttons.audioContinuous) {
        buttons.audioContinuous.addEventListener('click', () => {
          // Toggle audio mode to continuous
          if (window.audioSystem && window.audioSystem.soundScheduler) {
            // Enable continuous mode
            if (window.audioSystem.soundScheduler.setContinuousMode) {
              window.audioSystem.soundScheduler.setContinuousMode(true);
            }
            window.audioSystem.soundScheduler.maxSoundsPerSecond = 30;
            showStatus('Continuous Audio Mode Activated');
          } else if (window.enableContinuousSoundMode && window.app) {
            window.enableContinuousSoundMode(window.app);
            showStatus('Continuous Audio Mode Activated');
          } else {
            showStatus('Audio system not fully initialized');
          }
        });
      }
      
      if (buttons.audioTest) {
        buttons.audioTest.addEventListener('click', () => {
          // Play test sound
          if (window.appControls && window.appControls.playSound) {
            window.appControls.playSound();
            showStatus('Test Sound Played');
          } else {
            showStatus('Audio test function not available');
          }
        });
      }
      
      // Status indicator function
      function showStatus(message) {
        const statusIndicator = document.getElementById('status-indicator');
        statusIndicator.textContent = message;
        statusIndicator.classList.add('visible');
        
        // Hide after 2 seconds
        setTimeout(() => {
          statusIndicator.classList.remove('visible');
        }, 2000);
      }
      
      // Make showStatus available globally
      window.showStatus = showStatus;

      // Add event listeners for new effect buttons
      document.getElementById('btn-facet-highlight').addEventListener('click', function() {
        if (window.appControls && window.appControls.toggleFacetHighlighting) {
            const isActive = window.appControls.toggleFacetHighlighting();
            this.classList.toggle('active', isActive);
        }
      });

      document.getElementById('btn-spiky').addEventListener('click', function() {
        if (window.appControls && window.appControls.toggleSpikyMode) {
            const isActive = window.appControls.toggleSpikyMode();
            this.classList.toggle('active', isActive);
        }
      });

      document.getElementById('btn-trail').addEventListener('click', function() {
        if (window.appControls && window.appControls.toggleTrailEffect) {
            const isActive = window.appControls.toggleTrailEffect();
            this.classList.toggle('active', isActive);
        }
      });
    });

    // Simplified debug function that works with both approaches
    function debugAudio() {
      if (window.app) {
        if (window.debugAudioSystem) {
          // Use the globally available function that was set by either main.js or debug.js
          window.debugAudioSystem(window.app);
        } else {
          // Dynamic import fallback
          import('./js/audio/core.js')
            .then(module => {
              if (module.debugAudioSystem) {
                module.debugAudioSystem(window.app);
              } else {
                console.log("debugAudioSystem not exported from module");
                console.log("Audio state:", 
                  window.app.audioContext ? "Context exists" : "No context",
                  window.app.soundManager ? "Manager exists" : "No manager");
              }
            })
            .catch(err => {
              console.error("Error importing audio core:", err);
            });
        }
      } else {
        console.log("App not initialized yet");
      }
    }
  </script>
  
  <style>
    /* Add styles for audio buttons */
    .audio-button {
      background-color: #2a4494;
    }
    
    .audio-button:hover {
      background-color: #3a5494;
    }
    
    #btn-audio-continuous {
      background-color: #447744;
    }
    
    #btn-audio-continuous:hover {
      background-color: #558855;
    }
    
    #btn-audio-test {
      background-color: #774477;
    }
    
    #btn-audio-test:hover {
      background-color: #885588;
    }
    
    /* Style for the new controls */
    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    
    .controls button {
      padding: 8px 16px;
      background-color: #2a4494;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .controls button:hover {
      background-color: #3a5494;
    }

    /* Add styles for audio controls */
    .audio-controls {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
    
    .control-group {
      margin-bottom: 10px;
    }
    
    .control-group label {
      display: block;
      color: white;
      margin-bottom: 5px;
    }
    
    .control-group input[type="checkbox"] {
      margin-right: 5px;
    }
    
    .control-group input[type="range"] {
      width: 100%;
    }

    /* Add styles for debug panel */
    .audio-debug-panel {
      position: fixed;
      bottom: 80px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
    
    .audio-debug-panel button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
      padding: 5px;
      background: #4466aa;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .audio-debug-panel button:hover {
      background: #5577bb;
    }
    
    .volume-control {
      margin: 10px 0;
    }
    
    .volume-control label {
      display: block;
      color: white;
      margin-bottom: 5px;
    }
    
    .volume-control input {
      width: 100%;
    }
  </style>
</body>
</html>